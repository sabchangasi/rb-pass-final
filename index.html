<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Navratri Pass Generator - A4 Batch System (Fixed)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/heic2any/0.0.4/heic2any.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700;800&family=Noto+Sans+Gujarati:wght@400;600;700&display=swap" rel="stylesheet">
    
    <meta name="theme-color" content="#6366F1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="NavratriPass">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#6366F1">
    <meta name="msapplication-tap-highlight" content="no">

    <link rel="apple-touch-icon" sizes="180x180" href="./ios/180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="./ios/152.png">
    <link rel="apple-touch-icon" sizes="144x144" href="./ios/144.png">
    <link rel="apple-touch-icon" sizes="120x120" href="./ios/120.png">

    <link rel="manifest" href="./manifest.json">

    <link rel="apple-touch-startup-image" href="./images/splash-2048x2732.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="./images/splash-1668x2224.png" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="./images/splash-1536x2048.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="./images/splash-1125x2436.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="./images/splash-1242x2208.png" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="./images/splash-750x1334.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="./images/splash-828x1792.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <style>
        :root {
            --primary: #6366F1;
            --primary-dark: #4F46E5;
            --secondary: #8B5CF6;
            --success: #10B981;
            --success-dark: #059669;
            --warning: #F59E0B;
            --error: #EF4444;
            --info: #3B82F6;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --shadow-2xl: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            --radius-sm: 6px;
            --radius: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-2xl: 20px;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            color: var(--gray-700);
        }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            gap: 1rem;
            transition: opacity 0.3s ease;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        #loading-overlay p {
            font-weight: 600;
            color: var(--gray-700);
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-2xl);
            overflow: hidden;
            border: 1px solid var(--gray-200);
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: clamp(1.8rem, 4vw, 2.5rem);
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 400;
        }
        
        .main-content {
            padding: 40px;
        }
        
        .template-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            font-family: 'Poppins', sans-serif;
            flex: 1;
            min-width: 100px;
            padding: 12px 16px;
            border: 2px solid var(--gray-200);
            background: white;
            color: var(--gray-600);
            font-weight: 600;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
        }

        .tab-btn.completed::after {
            content: 'âœ“';
            position: absolute;
            top: -8px;
            right: -8px;
            width: 22px;
            height: 22px;
            background: var(--success);
            color: white;
            border-radius: 50%;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            border: 2px solid white;
            animation: popIn 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        
        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .tab-progress {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 32px;
        }

        .progress-text {
            font-weight: 600;
            color: var(--gray-700);
        }

        .mini-progress-bar {
            flex: 1;
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
        }

        .mini-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--primary));
            transition: width 0.3s ease;
        }
        
        .form-section {
            background: var(--gray-50);
            border-radius: var(--radius-xl);
            padding: 32px;
            border: 1px solid var(--gray-200);
            margin-bottom: 32px;
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-group:last-child {
            margin-bottom: 0;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .form-input {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            font-size: 1rem;
            font-weight: 500;
            font-family: 'Poppins', sans-serif;
            transition: var(--transition);
            background: white;
            box-shadow: var(--shadow-sm);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgb(99 102 241 / 0.1), var(--shadow);
        }

        .form-input.error {
            border-color: var(--error);
            box-shadow: 0 0 0 4px rgb(239 68 68 / 0.1), var(--shadow);
        }

        .form-input.success {
            border-color: var(--success);
            box-shadow: 0 0 0 4px rgb(16 185 129 / 0.1), var(--shadow);
        }

        .input-error {
            color: var(--error);
            font-size: 0.875rem;
            margin-top: 4px;
            display: none;
        }

        .input-success {
            color: var(--success);
            font-size: 0.875rem;
            margin-top: 4px;
            display: none;
        }
        
        .gujarati-input {
            font-family: 'Noto Sans Gujarati', 'Poppins', sans-serif;
            font-size: 1.125rem;
        }
        
        .upload-area {
            border: 3px dashed var(--gray-300);
            border-radius: var(--radius-xl);
            padding: 48px 24px;
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
            position: relative;
            background: white;
        }
        
        .upload-area.dragover {
            border-color: var(--primary);
            background: rgb(99 102 241 / 0.05);
        }
        
        .upload-area input[type="file"] {
            display: none;
        }
        
        .upload-icon {
            font-size: 2rem; 
            color: var(--gray-400); 
            margin-bottom: 12px;
        }
        
        .upload-text strong {
            color: var(--primary);
        }
        
        .upload-hint {
            color: var(--gray-500);
            font-size: 0.875rem;
            margin-top: 8px;
        }
        
        .file-info {
            margin-top: 16px;
            padding: 12px;
            border-radius: var(--radius-lg);
            font-weight: 500;
            display: none;
            text-align: center;
        }
        
        .photo-preview-container {
            margin-top: 16px;
            text-align: center;
            display: none;
        }
        
        .photo-preview {
            width: 120px;
            height: 150px;
            border-radius: var(--radius-lg);
            object-fit: cover;
            border: 3px solid var(--primary);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-group {
            display: flex;
            gap: 16px;
            justify-content: flex-end;
            margin-top: 24px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: var(--radius-lg);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-family: 'Poppins', sans-serif;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: var(--shadow);
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }
        
        .btn-secondary {
            background: white;
            color: var(--gray-700);
            border: 2px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
        }

        .btn-danger {
            background: white;
            color: var(--error);
            border: 2px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: var(--shadow-sm) !important;
        }
        
        .a4-preview-container {
            text-align: center;
            padding: 40px;
            background: var(--gray-50);
            border-radius: var(--radius-xl);
            margin: 32px 0;
            display: none;
        }

        #a4Canvas {
            max-width: 100%;
            height: auto;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            background: white;
        }

        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .btn.loading .loading-spinner {
            display: inline-block;
        }
        
        .print-canvas {
            position: absolute;
            left: -9999px;
            top: -9999px;
        }
        
        @page {
            size: 210mm 297mm;
            margin: 0;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .print-canvas, .print-canvas * {
                visibility: visible;
            }
            .print-canvas {
                position: absolute;
                left: 0;
                top: 0;
                width: 210mm !important;
                height: 297mm !important;
                transform: none !important;
            }
        }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .main-content, .header { padding: 20px; }
            .form-section { padding: 24px; }
            .btn-group { flex-direction: column; align-items: stretch; }
            .btn { width: 100%; }
        }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p>Loading fonts & resources...</p>
    </div>

    <div class="container">
        <div class="header">
            <h1>Navratri Pass Generator</h1>
            <p>By :- Rishit Bakraniya</p>
        </div>
        
        <div class="main-content">
            <div id="formView">
                <div class="template-tabs">
                    <button class="tab-btn" data-template="0">Template 1</button>
                    <button class="tab-btn" data-template="1">Template 2</button>
                    <button class="tab-btn" data-template="2">Template 3</button>
                    <button class="tab-btn" data-template="3">Template 4</button>
                    <button class="tab-btn" data-template="4">Template 5</button>
                    <button class="tab-btn" data-template="5">Template 6</button>
                </div>
                
                <div class="tab-progress">
                    <span class="progress-text">0/6 completed</span>
                    <div class="mini-progress-bar">
                        <div class="mini-progress-fill" style="width: 0%"></div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-group">
                        <label class="form-label" for="serialNumber">Serial Number (1-9999)</label>
                        <input type="tel" id="serialNumber" class="form-input" placeholder="Enter 1-4 digits" inputmode="numeric" pattern="[0-9]*" maxlength="4">
                        <div class="input-error" id="serialError"></div>
                        <div class="input-success" id="serialSuccess"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Photo Upload</label>
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-icon">ðŸ“·</div>
                            <div class="upload-text"><strong>Click to upload</strong> or drag and drop</div>
                            <div class="upload-hint">JPG, PNG, WebP, HEIC (for iPhones)</div>
                            <input type="file" id="photoInput" accept="image/jpeg,image/png,image/webp,image/heic,image/heif">
                        </div>
                        <div class="file-info" id="fileInfo"></div>
                        <div class="photo-preview-container" id="photoPreviewContainer">
                            <img id="photoPreview" class="photo-preview" alt="Photo preview">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="gujaratiName">àª¨àª¾àª® (Name in Gujarati)</label>
                        <input type="text" id="gujaratiName" class="form-input gujarati-input" placeholder="àª—à«àªœàª°àª¾àª¤à«€ àª¨àª¾àª® àª²àª–à«‹" maxlength="50">
                        <div class="input-error" id="nameError"></div>
                        <div class="input-success" id="nameSuccess"></div>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-danger" id="clearTemplateBtn">Clear Template</button>
                    <button class="btn btn-secondary" id="saveTemplateBtn">Save Template</button>
                    <button class="btn btn-primary" id="generateA4Btn" disabled>Generate A4 PDF</button>
                </div>
            </div>

            <div class="a4-preview-container" id="a4PreviewView">
                <h2>A4 Certificate Preview</h2>
                <p>Review the generated A4 sheet below.</p>
                <canvas id="a4Canvas"></canvas>
                <div class="btn-group">
                    <button class="btn btn-secondary" id="backToEditBtn">Back to Edit</button>
                    <button class="btn btn-primary" id="downloadA4PdfBtn">
                        <div class="loading-spinner"></div>
                        Download PDF
                    </button>
                    <button class="btn btn-primary" id="printDirectBtn">Print Direct</button>
                    <button class="btn btn-danger" id="resetAllBtn">Reset All</button>
                </div>
            </div>
        </div>
    </div>
    
    <canvas id="printCanvas" class="print-canvas"></canvas>

    <script>
        // Configuration
        const CONFIG = {
            A4_MM: { width: 210, height: 294 }, // Standard A4 in millimeters
            DPI: 300, // High quality print resolution
            PHOTO: { cornerRadius: 2.5 }, // Radius in mm
            LOCAL_STORAGE_KEY: 'navratriPassData_v9',
            SERIAL: {
                MIN: 1,
                MAX: 9999,
                MIN_FONT_SIZE: 30,
                MAX_FONT_SIZE: 200
            },
            NAME: {
                MIN_LENGTH: 2,
                MAX_LENGTH: 50,
                MIN_FONT_SIZE: 20,
                MAX_FONT_SIZE: 100
            }
        };

        // Convert mm to pixels at specified DPI
        function mmToPixels(mm, dpi = CONFIG.DPI) {
            return Math.round((mm * dpi) / 25.4);
        }

        // Template coordinates in millimeters (measured from A4 paper)
        const TEMPLATES_MM = {
            template1: {
                photo: { x: 4.55, y: 50, width: 28.1, height: 35.0 },
                serial: { x: 34.55, y: 50.1, width: 65.4, height: 34.7 },
                name: { x: 15.05, y: 86.4, width: 83.0, height: 7.1 }
            },
            template2: {
                photo: { x: 109.85, y: 49.95, width: 28.1, height: 35.0 },
                serial: { x: 139.85, y: 50.05, width: 65.4, height: 34.7 },
                name: { x: 120.35, y: 86.35, width: 83.0, height: 7.1 }
            },
            template3: {
                photo: { x: 4.6, y: 148.2, width: 28.1, height: 35.0 },
                serial: { x: 34.6, y: 148.3, width: 65.4, height: 34.7 },
                name: { x: 15.1, y: 184.1, width: 83.0, height: 7.1 }
            },
            template4: {
                photo: { x: 109.9, y: 148.11, width: 28.1, height: 35.0 },
                serial: { x: 139.91, y: 148.21, width: 65.4, height: 34.7 },
                name: { x: 120.41, y: 184.01, width: 83.0, height: 7.1 }
            },
            template5: {
                photo: { x: 4.68, y: 246.4, width: 28.1, height: 35.0 },
                serial: { x: 34.68, y: 246.5, width: 65.4, height: 34.7 },
                name: { x: 15.18, y: 282.3, width: 83.0, height: 7.1 }
            },
            template6: {
                photo: { x: 109.93, y: 246.35, width: 28.1, height: 35.0 },
                serial: { x: 139.93, y: 246.45, width: 65.4, height: 34.7 },
                name: { x: 120.43, y: 282.25, width: 83.0, height: 7.1 }
            }
        };

        // Helper function to get pixel coordinates
        function getTemplatePixels(templateName) {
            const template = TEMPLATES_MM[templateName];
            return {
                photo: {
                    x: mmToPixels(template.photo.x),
                    y: mmToPixels(template.photo.y),
                    width: mmToPixels(template.photo.width),
                    height: mmToPixels(template.photo.height)
                },
                serial: {
                    x: mmToPixels(template.serial.x),
                    y: mmToPixels(template.serial.y),
                    width: mmToPixels(template.serial.width),
                    height: mmToPixels(template.serial.height)
                },
                name: {
                    x: mmToPixels(template.name.x),
                    y: mmToPixels(template.name.y),
                    width: mmToPixels(template.name.width),
                    height: mmToPixels(template.name.height)
                }
            };
        }

        // Application initialization
        document.addEventListener('DOMContentLoaded', () => {
            const loadingOverlay = document.getElementById('loading-overlay');
            document.fonts.ready.then(() => {
                console.log('All fonts loaded and ready.');
                const app = new NavratriPassApp();
                app.init();
                loadingOverlay.style.opacity = '0';
                setTimeout(() => loadingOverlay.style.display = 'none', 300);
            });
        });

        class NavratriPassApp {
            constructor() {
                this.state = {
                    templatesData: Array(6).fill(null).map(() => ({
                        serialNumber: null,
                        photo: null,
                        gujaratiName: null,
                        completed: false
                    })),
                    currentTemplateIndex: 0,
                    a4Context: null
                };

                this.dom = {
                    formView: document.getElementById('formView'),
                    a4PreviewView: document.getElementById('a4PreviewView'),
                    serialInput: document.getElementById('serialNumber'),
                    nameInput: document.getElementById('gujaratiName'),
                    photoInput: document.getElementById('photoInput'),
                    uploadArea: document.getElementById('uploadArea'),
                    fileInfo: document.getElementById('fileInfo'),
                    photoPreviewContainer: document.getElementById('photoPreviewContainer'),
                    photoPreview: document.getElementById('photoPreview'),
                    saveTemplateBtn: document.getElementById('saveTemplateBtn'),
                    tabButtons: document.querySelectorAll('.tab-btn'),
                    progressText: document.querySelector('.progress-text'),
                    progressFill: document.querySelector('.mini-progress-fill'),
                    generateA4Btn: document.getElementById('generateA4Btn'),
                    a4Canvas: document.getElementById('a4Canvas'),
                    printCanvas: document.getElementById('printCanvas'),
                    serialError: document.getElementById('serialError'),
                    serialSuccess: document.getElementById('serialSuccess'),
                    nameError: document.getElementById('nameError'),
                    nameSuccess: document.getElementById('nameSuccess')
                };
            }

            // Validation utilities
            validateSerial(value) {
                if (!value || value.trim() === '') {
                    return { valid: false, message: 'Serial number is required' };
                }

                const numValue = parseInt(value, 10);
                if (isNaN(numValue)) {
                    return { valid: false, message: 'Please enter a valid number' };
                }

                if (numValue < CONFIG.SERIAL.MIN || numValue > CONFIG.SERIAL.MAX) {
                    return { valid: false, message: `Serial must be between ${CONFIG.SERIAL.MIN} and ${CONFIG.SERIAL.MAX}` };
                }

                return { valid: true, message: 'Valid serial number' };
            }

            validateName(value) {
                if (!value || value.trim() === '') {
                    return { valid: false, message: 'Name is required' };
                }

                if (value.trim().length < CONFIG.NAME.MIN_LENGTH) {
                    return { valid: false, message: `Name must be at least ${CONFIG.NAME.MIN_LENGTH} characters` };
                }

                if (value.trim().length > CONFIG.NAME.MAX_LENGTH) {
                    return { valid: false, message: `Name must be less than ${CONFIG.NAME.MAX_LENGTH} characters` };
                }

                return { valid: true, message: 'Valid name' };
            }

            showValidation(inputElement, errorElement, successElement, validation) {
                if (validation.valid) {
                    inputElement.classList.remove('error');
                    inputElement.classList.add('success');
                    errorElement.style.display = 'none';
                    successElement.textContent = validation.message;
                    successElement.style.display = 'block';
                } else {
                    inputElement.classList.remove('success');
                    inputElement.classList.add('error');
                    successElement.style.display = 'none';
                    errorElement.textContent = validation.message;
                    errorElement.style.display = 'block';
                }
            }

            clearValidation(inputElement, errorElement, successElement) {
                inputElement.classList.remove('error', 'success');
                errorElement.style.display = 'none';
                successElement.style.display = 'none';
            }

            // State management
            async loadState() {
                const savedData = localStorage.getItem(CONFIG.LOCAL_STORAGE_KEY);
                if (savedData) {
                    try {
                        const parsedData = JSON.parse(savedData);
                        if (Array.isArray(parsedData) && parsedData.length === 6) {
                            for (let i = 0; i < parsedData.length; i++) {
                                if (parsedData[i] && parsedData[i].photo) {
                                    parsedData[i].photo = await this.dataUrlToCanvas(parsedData[i].photo);
                                }
                            }
                            this.state.templatesData = parsedData;
                        }
                    } catch (e) {
                        console.error("Failed to parse saved data:", e);
                        localStorage.removeItem(CONFIG.LOCAL_STORAGE_KEY);
                    }
                }
            }

            saveState() {
                try {
                    const serializableData = this.state.templatesData.map(d => ({
                        ...d,
                        photo: d && d.photo instanceof HTMLCanvasElement ? d.photo.toDataURL() : (d ? d.photo : null)
                    }));
                    localStorage.setItem(CONFIG.LOCAL_STORAGE_KEY, JSON.stringify(serializableData));
                } catch (e) {
                    console.error("Could not save to local storage:", e);
                }
            }

            updateCurrentTemplate() {
                const data = this.state.templatesData[this.state.currentTemplateIndex];
                const serialValue = this.dom.serialInput.value.trim();
                
                // Format serial number to 4 digits
                if (serialValue && !isNaN(serialValue)) {
                    data.serialNumber = serialValue.padStart(4, '0');
                } else {
                    data.serialNumber = null;
                }

                data.gujaratiName = this.dom.nameInput.value.trim() || null;
                data.completed = this.isValidTemplate(data);
                
                this.saveState();
                this.updateUI();
                this.updateSaveButtonState('saved');
            }

            isValidTemplate(data) {
                if (!data || !data.serialNumber || !data.photo || !data.gujaratiName) return false;
                
                const serialValidation = this.validateSerial(data.serialNumber);
                const nameValidation = this.validateName(data.gujaratiName);
                
                return serialValidation.valid && nameValidation.valid;
            }

            // UI Management
            updateUI() {
                this.updateTabs();
                this.updateProgress();
            }

            updateTabs() {
                this.dom.tabButtons.forEach((btn, i) => {
                    const data = this.state.templatesData[i];
                    const wasCompleted = btn.classList.contains('completed');
                    const isCompleted = data ? data.completed : false;
                    
                    btn.classList.toggle('active', i === this.state.currentTemplateIndex);
                    
                    if (isCompleted && !wasCompleted) {
                        btn.classList.add('completed');
                    } else if (!isCompleted && wasCompleted) {
                        btn.classList.remove('completed');
                    }
                });
            }

            updateProgress() {
                const completedCount = this.state.templatesData.filter(t => t && t.completed).length;
                this.dom.progressText.textContent = `${completedCount}/6 completed`;
                this.dom.progressFill.style.width = `${(completedCount / 6) * 100}%`;
                this.dom.generateA4Btn.disabled = completedCount === 0;
            }

            loadTemplateForm(index) {
                const data = this.state.templatesData[index];
                
                // Load form values
                this.dom.serialInput.value = data ? (data.serialNumber || '') : '';
                this.dom.nameInput.value = data ? (data.gujaratiName || '') : '';
                
                // Clear validations
                this.clearValidation(this.dom.serialInput, this.dom.serialError, this.dom.serialSuccess);
                this.clearValidation(this.dom.nameInput, this.dom.nameError, this.dom.nameSuccess);
                
                // Load photo
                this.dom.photoPreviewContainer.style.display = 'none';
                this.setFileInfoState('', 'idle');
                this.dom.photoInput.value = '';

                if (data && data.photo) {
                    this.dom.photoPreview.src = data.photo.toDataURL();
                    this.dom.photoPreviewContainer.style.display = 'block';
                }
                
                this.updateSaveButtonState('idle');
            }

            updateSaveButtonState(status) {
                const btn = this.dom.saveTemplateBtn;
                if (status === 'dirty') {
                    btn.style.background = 'var(--warning)';
                    btn.textContent = 'Save Changes*';
                } else if (status === 'saved') {
                    btn.style.background = 'var(--success)';
                    btn.textContent = 'Saved!';
                    setTimeout(() => this.updateSaveButtonState('idle'), 1000);
                } else {
                    btn.style.background = '';
                    btn.textContent = 'Save Template';
                }
            }

            setFileInfoState(message, type) {
                const states = {
                    error: { bg: 'rgb(239 68 68 / 0.1)', color: 'var(--error)', icon: 'âŒ' },
                    success: { bg: 'rgb(16 185 129 / 0.1)', color: 'var(--success-dark)', icon: 'âœ…' },
                    loading: { bg: 'rgb(59 130 246 / 0.1)', color: 'var(--info)', icon: 'â³' },
                    idle: {}
                };
                
                const stateInfo = states[type];
                if (type === 'idle' || !message) {
                    this.dom.fileInfo.style.display = 'none';
                } else {
                    this.dom.fileInfo.innerHTML = `${stateInfo.icon} ${message}`;
                    this.dom.fileInfo.style.display = 'block';
                    this.dom.fileInfo.style.background = stateInfo.bg;
                    this.dom.fileInfo.style.color = stateInfo.color;
                }
            }

            // Event handlers
            switchTemplate(index) {
                this.state.currentTemplateIndex = index;
                this.loadTemplateForm(index);
                this.updateTabs();
            }

            saveAndSwitchTemplate() {
                this.updateCurrentTemplate();
                const nextIndex = (this.state.currentTemplateIndex + 1) % 6;
                this.switchTemplate(nextIndex);
            }

            clearCurrentTemplate() {
                if (confirm('Are you sure you want to clear this template?')) {
                    this.state.templatesData[this.state.currentTemplateIndex] = {
                        serialNumber: null,
                        photo: null,
                        gujaratiName: null,
                        completed: false
                    };
                    this.loadTemplateForm(this.state.currentTemplateIndex);
                    this.saveState();
                    this.updateUI();
                }
            }

            resetAll() {
                if (confirm('Are you sure you want to reset ALL 6 templates? This action cannot be undone.')) {
                    this.state.templatesData = Array(6).fill(null).map(() => ({
                        serialNumber: null,
                        photo: null,
                        gujaratiName: null,
                        completed: false
                    }));
                    this.state.currentTemplateIndex = 0;
                    this.loadTemplateForm(0);
                    this.saveState();
                    this.updateUI();
                    this.dom.a4PreviewView.style.display = 'none';
                    this.dom.formView.style.display = 'block';
                }
            }

            async handleFileSelect(file) {
                const isHeic = file.type === 'image/heic' || file.type === 'image/heif' || file.name.toLowerCase().endsWith('.heic');
                
                if (!file.type.startsWith('image/') && !isHeic) {
                    this.setFileInfoState('Invalid file type. Please upload an image.', 'error');
                    return;
                }
                
                if (file.size > 15 * 1024 * 1024) {
                    this.setFileInfoState('File too large (max 15MB).', 'error');
                    return;
                }

                let blob = file;
                if (isHeic) {
                    this.setFileInfoState('Converting HEIC image, please wait...', 'loading');
                    try {
                        blob = await heic2any({ blob: file, toType: "image/jpeg", quality: 0.9 });
                    } catch (e) {
                        this.setFileInfoState('Could not convert HEIC image.', 'error');
                        return;
                    }
                }
                
                this.setFileInfoState('Processing your photo...', 'loading');

                try {
                    const img = await this.blobToImage(blob);
                    const targetDimsMM = TEMPLATES_MM.template1.photo;
                    const processedPhoto = this.processPhoto(img, targetDimsMM.width, targetDimsMM.height);
                    
                    // Update current template data
                    this.state.templatesData[this.state.currentTemplateIndex].photo = processedPhoto;
                    
                    this.dom.photoPreview.src = processedPhoto.toDataURL();
                    this.dom.photoPreviewContainer.style.display = 'block';
                    this.setFileInfoState(`${file.name} processed successfully.`, 'success');
                    this.updateSaveButtonState('dirty');
                } catch (e) {
                    this.setFileInfoState('Could not process the image file.', 'error');
                    console.error('Image processing error:', e);
                }
            }

            // Core photo processing
            processPhoto(img, targetWidthMM, targetHeightMM) {
                const targetWidth = mmToPixels(targetWidthMM);
                const targetHeight = mmToPixels(targetHeightMM);
                const canvas = document.createElement('canvas');
                canvas.width = targetWidth;
                canvas.height = targetHeight;
                const ctx = canvas.getContext('2d');

                // Calculate crop dimensions to fit aspect ratio
                const targetAspectRatio = targetWidth / targetHeight;
                const imageAspectRatio = img.width / img.height;
                let sx = 0, sy = 0, sWidth = img.width, sHeight = img.height;

                if (imageAspectRatio > targetAspectRatio) {
                    sWidth = img.height * targetAspectRatio;
                    sx = (img.width - sWidth) / 2;
                } else {
                    sHeight = img.width / targetAspectRatio;
                    sy = (img.height - sHeight) / 2;
                }

                // Create rounded corners
                const cornerRadius = mmToPixels(CONFIG.PHOTO.cornerRadius);
                ctx.beginPath();
                ctx.moveTo(cornerRadius, 0);
                ctx.lineTo(canvas.width - cornerRadius, 0);
                ctx.quadraticCurveTo(canvas.width, 0, canvas.width, cornerRadius);
                ctx.lineTo(canvas.width, canvas.height - cornerRadius);
                ctx.quadraticCurveTo(canvas.width, canvas.height, canvas.width - cornerRadius, canvas.height);
                ctx.lineTo(cornerRadius, canvas.height);
                ctx.quadraticCurveTo(0, canvas.height, 0, canvas.height - cornerRadius);
                ctx.lineTo(0, cornerRadius);
                ctx.quadraticCurveTo(0, 0, cornerRadius, 0);
                ctx.closePath();
                ctx.clip();
                
                // Draw image with high quality
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                ctx.drawImage(img, sx, sy, sWidth, sHeight, 0, 0, canvas.width, canvas.height);
                return canvas;
            }

            // A4 Certificate generation
            generateA4Certificate() {
                if (!this.state.a4Context) {
                    // Set canvas to exact A4 dimensions in pixels
                    this.dom.a4Canvas.width = mmToPixels(CONFIG.A4_MM.width);
                    this.dom.a4Canvas.height = mmToPixels(CONFIG.A4_MM.height);
                    this.state.a4Context = this.dom.a4Canvas.getContext('2d');
                    this.state.a4Context.imageSmoothingEnabled = true;
                    this.state.a4Context.imageSmoothingQuality = 'high';
                }
                
                // Clear and set white background
                this.state.a4Context.fillStyle = 'white';
                this.state.a4Context.fillRect(0, 0, this.dom.a4Canvas.width, this.dom.a4Canvas.height);

                this.state.templatesData.forEach((data, index) => {
                    if (data && data.completed) {
                        const templatePixels = getTemplatePixels(`template${index + 1}`);
                        this.renderTemplateOnA4(this.state.a4Context, data, templatePixels);
                    }
                });
            }

            renderTemplateOnA4(ctx, data, template) {
                // Draw photo
                if (data.photo) {
                    ctx.drawImage(data.photo, template.photo.x, template.photo.y, template.photo.width, template.photo.height);
                }
                
                // Set text shadow for better visibility
                ctx.shadowColor = 'rgba(0, 0, 0, 0.2)';
                ctx.shadowOffsetX = 1;
                ctx.shadowOffsetY = 1;
                ctx.shadowBlur = 3;
                ctx.fillStyle = '#000000';

                // Render serial number with adaptive sizing
                if (data.serialNumber) {
                    this.renderSerialNumber(ctx, data.serialNumber, template.serial);
                }

                // Render Gujarati name with adaptive sizing
                if (data.gujaratiName) {
                    this.renderGujaratiName(ctx, data.gujaratiName, template.name);
                }
                
                // Clear shadow
                ctx.shadowColor = 'transparent';
            }

            // Fixed serial number rendering with maximum space utilization
            renderSerialNumber(ctx, serialNumber, box) {
                // More aggressive padding - use almost all available space
                const horizontalPadding = 15; // Minimal padding
                const verticalPadding = 10;   // Minimal padding
                
                const availableWidth = box.width - (horizontalPadding * 2);
                const availableHeight = box.height - (verticalPadding * 2);
                
                ctx.save();
                ctx.textBaseline = 'middle';
                ctx.textAlign = 'center';
                
                // Start with font size based on available height (more aggressive)
                let fontSize = Math.floor(availableHeight * 0.95); // Use 95% of height
                const fontWeight = 800;
                const fontFamily = "'Poppins', 'Helvetica Neue', sans-serif";
                
                // Fine-tune font size to fit width perfectly
                do {
                    ctx.font = `${fontWeight} ${fontSize}px ${fontFamily}`;
                    const textMetrics = ctx.measureText(serialNumber);
                    
                    // Check if text fits with some breathing room
                    if (textMetrics.width <= availableWidth * 0.98) { // Use 98% of width
                        break;
                    }
                    
                    fontSize -= 1; // Smaller decrements for precision
                } while (fontSize > CONFIG.SERIAL.MIN_FONT_SIZE);
                
                // Center the text perfectly in the box
                const centerX = box.x + box.width / 2;
                const centerY = box.y + box.height / 2;
                
                ctx.fillText(serialNumber, centerX, centerY);
                ctx.restore();
            }

            // Fixed Gujarati name rendering with proper scaling
            renderGujaratiName(ctx, name, box) {
                const padding = 20;
                const availableWidth = box.width - (padding * 2);
                const availableHeight = box.height;
                
                ctx.save();
                ctx.textBaseline = 'middle';
                ctx.textAlign = 'left'; // Left-aligned as requested
                ctx.textRendering = 'optimizeLegibility';
                
                // Start with maximum font size and reduce until it fits
                let fontSize = Math.min(CONFIG.NAME.MAX_FONT_SIZE, availableHeight * 0.8);
                let fontWeight = 700;
                let fontFamily = "'Noto Sans Gujarati', 'Shruti', sans-serif";
                
                do {
                    ctx.font = `${fontWeight} ${fontSize}px ${fontFamily}`;
                    const textMetrics = ctx.measureText(name);
                    
                    if (textMetrics.width <= availableWidth) {
                        break; // Text fits
                    }
                    
                    fontSize -= 1;
                } while (fontSize > CONFIG.NAME.MIN_FONT_SIZE);
                
                // Position text with left padding
                const textX = box.x + padding;
                const textY = box.y + box.height / 2;
                
                ctx.fillText(name, textX, textY);
                ctx.restore();
            }

            // Utility functions
            dataUrlToCanvas(dataUrl) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        canvas.getContext('2d').drawImage(img, 0, 0);
                        resolve(canvas);
                    };
                    img.onerror = reject;
                    img.src = dataUrl;
                });
            }

            blobToImage(blob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const img = new Image();
                        img.onload = () => resolve(img);
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            }

            // Event binding
            bindEvents() {
                // Tab switching
                this.dom.tabButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.switchTemplate(parseInt(e.target.dataset.template));
                    });
                });

                // Form interactions
                this.dom.saveTemplateBtn.addEventListener('click', () => {
                    this.saveAndSwitchTemplate();
                });

                this.dom.serialInput.addEventListener('input', (e) => {
                    // Only allow numbers
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                    
                    // Real-time validation
                    const validation = this.validateSerial(e.target.value);
                    this.showValidation(this.dom.serialInput, this.dom.serialError, this.dom.serialSuccess, validation);
                    this.updateSaveButtonState('dirty');
                });

                this.dom.nameInput.addEventListener('input', (e) => {
                    // Real-time validation
                    const validation = this.validateName(e.target.value);
                    this.showValidation(this.dom.nameInput, this.dom.nameError, this.dom.nameSuccess, validation);
                    this.updateSaveButtonState('dirty');
                });

                // File upload
                this.dom.uploadArea.addEventListener('click', () => {
                    this.dom.photoInput.click();
                });

                this.dom.uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    this.dom.uploadArea.classList.add('dragover');
                });

                this.dom.uploadArea.addEventListener('dragleave', () => {
                    this.dom.uploadArea.classList.remove('dragover');
                });

                this.dom.uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    this.dom.uploadArea.classList.remove('dragover');
                    if (e.dataTransfer.files.length) {
                        this.handleFileSelect(e.dataTransfer.files[0]);
                    }
                });

                this.dom.photoInput.addEventListener('change', (e) => {
                    if (e.target.files.length) {
                        this.handleFileSelect(e.target.files[0]);
                    }
                });

                // Action buttons
                document.getElementById('clearTemplateBtn').addEventListener('click', () => {
                    this.clearCurrentTemplate();
                });

                document.getElementById('generateA4Btn').addEventListener('click', () => {
                    this.updateCurrentTemplate();
                    
                    if (this.state.templatesData.filter(t => t && t.completed).length === 0) {
                        alert("At least one template must be completed before generating.");
                        return;
                    }
                    
                    this.dom.formView.style.display = 'none';
                    this.dom.a4PreviewView.style.display = 'block';
                    this.generateA4Certificate();
                });

                document.getElementById('backToEditBtn').addEventListener('click', () => {
                    this.dom.a4PreviewView.style.display = 'none';
                    this.dom.formView.style.display = 'block';
                });

                document.getElementById('downloadA4PdfBtn').addEventListener('click', (e) => {
                    const btn = e.currentTarget;
                    btn.classList.add('loading');
                    
                    setTimeout(() => {
                        const { jsPDF } = window.jspdf;
                        
                        // Create PDF with exact A4 dimensions
                        const pdf = new jsPDF({
                            orientation: 'portrait',
                            unit: 'mm',
                            format: [CONFIG.A4_MM.width, CONFIG.A4_MM.height],
                            precision: 2,
                            compress: true
                        });
                        
                        // Get canvas as high-quality image
                        const imgData = this.dom.a4Canvas.toDataURL('image/jpeg', 0.95);
                        
                        // Add image to fill entire page exactly
                        pdf.addImage(
                            imgData, 
                            'JPEG', 
                            0, 0, 
                            CONFIG.A4_MM.width, 
                            CONFIG.A4_MM.height,
                            undefined,
                            'NONE' // No compression/scaling
                        );
                        
                        const filename = `navratri_batch_${new Date().toISOString().slice(0, 10)}.pdf`;
                        pdf.save(filename);
                        btn.classList.remove('loading');
                    }, 250);
                });


                document.getElementById('printDirectBtn').addEventListener('click', () => {
                    this.dom.printCanvas.width = this.dom.a4Canvas.width;
                    this.dom.printCanvas.height = this.dom.a4Canvas.height;
                    this.dom.printCanvas.getContext('2d').drawImage(this.dom.a4Canvas, 0, 0);
                    setTimeout(() => window.print(), 100);
                });

                document.getElementById('resetAllBtn').addEventListener('click', () => {
                    this.resetAll();
                });
            }

            // Initialize application
            async init() {
                await this.loadState();
                this.loadTemplateForm(this.state.currentTemplateIndex);
                this.updateUI();
                this.bindEvents();
            }
        }
    </script>

    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);

                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New content is available, notify user
                                    if (confirm('New version available! Click OK to update.')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });

            // Handle service worker updates
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                window.location.reload();
            });
        }

        // Add to homescreen prompt for iOS
        let deferredPrompt;
        let installButton;

        // Create install button
        function createInstallButton() {
            if (installButton) return;

            installButton = document.createElement('button');
            installButton.innerHTML = 'ðŸ“± Install App';
            installButton.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: linear-gradient(135deg, #6366F1, #8B5CF6);
                color: white;
                border: none;
                padding: 12px 16px;
                border-radius: 8px;
                font-weight: 600;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
                z-index: 1000;
                font-family: inherit;
                transition: all 0.2s;
            `;
            
            installButton.addEventListener('click', showInstallPrompt);
            document.body.appendChild(installButton);
        }

        // Show install prompt
        function showInstallPrompt() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the A2HS prompt');
                        hideInstallButton();
                    }
                    deferredPrompt = null;
                });
            } else if (isIOS()) {
                showIOSInstallInstructions();
            }
        }

        // Hide install button
        function hideInstallButton() {
            if (installButton) {
                installButton.style.display = 'none';
            }
        }

        // Check if iOS
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent);
        }

        // Show iOS install instructions
        function showIOSInstallInstructions() {
            const isStandalone = window.navigator.standalone;
            
            if (!isStandalone) {
                const modal = document.createElement('div');
                modal.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;">
                        <div style="background: white; padding: 30px; border-radius: 15px; max-width: 350px; text-align: center;">
                            <h3 style="margin: 0 0 15px 0; color: #374151;">Install App</h3>
                            <p style="margin: 0 0 20px 0; color: #6B7280; line-height: 1.5;">To install this app on your iOS device, tap the share button and then "Add to Home Screen".</p>
                            <div style="font-size: 2rem; margin: 20px 0;">ðŸ“±â¬†ï¸</div>
                            <button onclick="this.parentElement.parentElement.remove()" style="background: #6366F1; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer;">Got it</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
        }

        // Listen for beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            createInstallButton();
        });

        // Handle app installation
        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            hideInstallButton();
        });

        // Show install button for iOS users
        if (isIOS() && !window.navigator.standalone) {
            createInstallButton();
        }
    </script>
    </body>
</html>